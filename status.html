<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サーバー稼働状況 - StellaMC</title>
    <link rel="stylesheet" href="stella.css"> <link rel="stylesheet" href="status.css"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo-link" aria-label="StellaMC ホームへ">
                <img src="logo.png" alt="StellaMC ロゴ" id="logo-img">
            </a>
            <nav class="main-nav" id="main-navigation">
                <ul>
                    <li><a href="index.html" class="nav-link-item">ホーム</a></li>
                    <li><a href="rules.html" class="nav-link-item">ルール</a></li>
                    <li><a href="support.html" class="nav-link-item">支援</a></li>
                    <li><a href="status.html" class="active nav-link-item">サーバー状況</a></li>
                    <li><a href="http://stellamc.jp:6903/" target="_blank" rel="noopener noreferrer" class="nav-link-item">WebMap</a></li>
                    <li><a href="https://discord.gg/jurMJk7gqa" target="_blank" rel="noopener noreferrer" class="nav-link-item nav-discord-link"><i class="fab fa-discord"></i> Discord</a></li>
                </ul>
            </nav>
            <button class="hamburger-menu" aria-label="メニューを開閉する" aria-expanded="false" aria-controls="main-navigation">
                <span class="hamburger-bar"></span>
                <span class="hamburger-bar"></span>
                <span class="hamburger-bar"></span>
            </button>
        </div>
    </header>

    <main class="page-content-container">
        <div class="container">
            <div class="page-header animate-on-load" data-animation="fadeInUpCustom">
                <h1 class="page-main-title"><i class="fas fa-broadcast-tower icon-header"></i>サーバー稼働状況</h1>
                <p class="page-intro">
                    StellaMCの現在のサーバー状況やオンラインプレイヤーをリアルタイムで確認できます。<br>
                    データは数分ごとに更新される場合があります。
                </p>
            </div>

            <section id="overall-status" class="status-section animate-on-scroll" data-animation="fadeInUpCustom" data-animation-delay="0.1s">
                <h2 class="section-heading-styled"><i class="fas fa-network-wired"></i>総合ステータス</h2>
                <div class="overall-status-card">
                    <div class="status-indicator-wrapper">
                        <div class="status-indicator loading" id="overall-status-indicator">
                            <span>確認中...</span> <div class="pulse-dot loading"></div>
                        </div>
                    </div>
                    <div class="server-main-connection-info">
                        <p><strong><i class="fas fa-desktop"></i> Java版:</strong> <code>stellamc.jp</code></p>
                        <p><strong><i class="fas fa-mobile-alt"></i> 統合版:</strong> <code>stellamc.jp</code> (ポート: <code>6911</code>)</p>
                    </div>
                    <div class="total-players">
                        <i class="fas fa-users"></i>
                        現在の総プレイヤー数: <span class="player-count animated-number" id="total-player-count" data-target="0">0</span>
                    </div>
                </div>
            </section>

            <div class="server-cards-wrapper">
                <section id="sutera-server-status" class="status-section individual-server-section animate-on-scroll" data-animation="fadeInLeftCustom" data-animation-delay="0.2s">
                    <div class="server-card-content-wrapper">
                        <div class="server-icon-container">
                            <img src="https://api.mcsrvstat.us/icon/stellamc.jp:6908" alt="すてら鯖 アイコン" class="server-icon" id="sutera-server-icon">
                        </div>
                        <h3 class="server-name-title"><i class="fas fa-star server-title-icon"></i>すてら鯖</h3>
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-indicator loading small" id="sutera-status-indicator"><span>確認中</span><div class="pulse-dot loading"></div></div>
                                <div class="server-address-port-static"><code>stellamc.jp:6908</code></div>
                            </div>
                            <div class="server-player-info">
                                <p>プレイヤー数: <span class="player-count animated-number" id="sutera-player-count" data-target="0">0</span> / <span id="sutera-max-players">-</span></p>
                            </div>
                            <h4>オンラインプレイヤー <span class="player-list-count" id="sutera-player-list-count">(0)</span>:</h4>
                            <div class="player-list-container">
                                <div class="player-list-grid" id="sutera-player-list">
                                    <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div>
                                </div>
                            </div>
                            <button class="btn btn-small btn-view-more" id="sutera-view-more-btn" style="display: none;">すべて表示</button>
                            <p class="no-players-message" id="sutera-no-players" style="display:none;">現在オンラインのプレイヤーはいません。</p>
                        </div>
                    </div>
                </section>

                <section id="vanilla-server-status" class="status-section individual-server-section animate-on-scroll" data-animation="fadeInRightCustom" data-animation-delay="0.3s">
                     <div class="server-card-content-wrapper">
                        <div class="server-icon-container">
                            <img src="https://api.mcsrvstat.us/icon/stellamc.jp:6910" alt="バニラ鯖 アイコン" class="server-icon" id="vanilla-server-icon">
                        </div>
                        <h3 class="server-name-title"><i class="fas fa-leaf server-title-icon"></i>バニラ鯖</h3>
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-indicator loading small" id="vanilla-status-indicator"><span>確認中</span><div class="pulse-dot loading"></div></div>
                                <div class="server-address-port-static"><code>stellamc.jp:6910</code></div>
                            </div>
                            <div class="server-player-info">
                                <p>プレイヤー数: <span class="player-count animated-number" id="vanilla-player-count" data-target="0">0</span> / <span id="vanilla-max-players">-</span></p>
                            </div>
                            <h4>オンラインプレイヤー <span class="player-list-count" id="vanilla-player-list-count">(0)</span>:</h4>
                            <div class="player-list-container">
                                <div class="player-list-grid" id="vanilla-player-list">
                                    <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div> <div class="player-avatar-skeleton"></div>
                                </div>
                            </div>
                            <button class="btn btn-small btn-view-more" id="vanilla-view-more-btn" style="display: none;">すべて表示</button>
                            <p class="no-players-message" id="vanilla-no-players" style="display:none;">現在オンラインのプレイヤーはいません。</p>
                        </div>
                    </div>
                </section>
            </div>
             <p class="page-closing animate-on-scroll" data-animation="fadeInUpCustom" data-animation-delay="0.4s" style="margin-top: 40px;">
                サーバーの稼働状況は数分おきに更新される場合があります。<br>
                もし接続できない場合は、Discordサーバーでお知らせを確認するか、運営までお問い合わせください。
            </p>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="current-year"></span> StellaMC. All Rights Reserved.</p>
            <p class="small-text">Minecraft is a trademark of Mojang Synergies AB. This server is not affiliated with Mojang Synergies AB.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 共通ヘッダー・アニメーション処理 (前回同様) ---
            const hamburger = document.querySelector('.hamburger-menu');
            const nav = document.querySelector('.main-nav');
            if (hamburger && nav) { /* ... (省略) ... */ }
            const header = document.querySelector('header');
            if (header) { /* ... (省略) ... */ }
            const currentYearEl = document.getElementById('current-year');
            if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
            const animatedElements = document.querySelectorAll('.animate-on-scroll, .animate-on-load');
            if (animatedElements.length > 0 && typeof IntersectionObserver !== 'undefined') { /* ... (省略) ... */ }


            // --- ステータスページ専用JavaScript ---
            const API_BASE_URL = 'https://api.mcsrvstat.us/3/';
            const SUTERA_SERVER_ADDRESS = 'stellamc.jp:6908';
            const VANILLA_SERVER_ADDRESS = 'stellamc.jp:6910';
            const INITIAL_PLAYERS_TO_SHOW = 12; // 初期表示するプレイヤー数

            let totalOnlinePlayers = 0;

            function fetchServerStatus(serverAddress, serverIdPrefix) {
                const statusIndicatorEl = document.getElementById(`${serverIdPrefix}-status-indicator`);
                const playerCountEl = document.getElementById(`${serverIdPrefix}-player-count`);
                const maxPlayersEl = document.getElementById(`${serverIdPrefix}-max-players`);
                const playerListEl = document.getElementById(`${serverIdPrefix}-player-list`);
                const noPlayersMsgEl = document.getElementById(`${serverIdPrefix}-no-players`);
                const viewMoreBtn = document.getElementById(`${serverIdPrefix}-view-more-btn`);
                const serverIconEl = document.getElementById(`${serverIdPrefix}-server-icon`);
                const playerListCountEl = document.getElementById(`${serverIdPrefix}-player-list-count`);


                if (!statusIndicatorEl || !playerCountEl || !maxPlayersEl || !playerListEl || !noPlayersMsgEl || !viewMoreBtn || !playerListCountEl) {
                    console.error(`Elements for ${serverIdPrefix} not found.`);
                    return;
                }

                // アイコンURLはAPIレスポンスに含まれない場合があるので、固定で設定
                if(serverIconEl && serverIdPrefix === 'sutera') serverIconEl.src = `https://api.mcsrvstat.us/icon/${SUTERA_SERVER_ADDRESS}`;
                if(serverIconEl && serverIdPrefix === 'vanilla') serverIconEl.src = `https://api.mcsrvstat.us/icon/${VANILLA_SERVER_ADDRESS}`;


                fetch(`${API_BASE_URL}${serverAddress}`)
                    .then(response => response.json())
                    .then(data => {
                        statusIndicatorEl.classList.remove('loading');
                        statusIndicatorEl.querySelector('.pulse-dot').classList.remove('loading');

                        if (data.online) {
                            statusIndicatorEl.classList.add('online');
                            statusIndicatorEl.classList.remove('offline');
                            statusIndicatorEl.querySelector('span').textContent = 'オンライン';

                            const currentPlayers = data.players ? data.players.online : 0;
                            const maxPlayers = data.players ? data.players.max : '-';

                            animatePlayerCount(playerCountEl, currentPlayers);
                            maxPlayersEl.textContent = maxPlayers;
                            totalOnlinePlayers += currentPlayers;
                            updateTotalPlayerCount();

                            if (playerListCountEl) playerListCountEl.textContent = `(${currentPlayers})`;


                            playerListEl.innerHTML = ''; // 古いリストをクリア
                            if (currentPlayers > 0 && data.players.list) {
                                noPlayersMsgEl.style.display = 'none';
                                data.players.list.forEach((player, index) => {
                                    const playerName = typeof player === 'string' ? player : player.name; // APIのバージョンによる違いを吸収
                                    const playerUUID = typeof player === 'object' && player.uuid ? player.uuid : playerName; // UUIDがなければ名前で代替

                                    const playerDiv = document.createElement('div');
                                    playerDiv.classList.add('player-avatar');
                                    const isBedrock = playerName.startsWith('.');
                                    playerDiv.classList.toggle('bedrock-player', isBedrock);
                                    playerDiv.classList.toggle('java-player', !isBedrock);
                                    playerDiv.title = playerName;
                                    if (index >= INITIAL_PLAYERS_TO_SHOW) {
                                        playerDiv.style.display = 'none'; // 初期は非表示
                                        playerDiv.classList.add('hidden-player');
                                    }

                                    const img = document.createElement('img');
                                    img.src = `https://minotar.net/avatar/${playerUUID}/32.png`; // UUIDか名前で取得
                                    img.alt = playerName;
                                    img.onerror = function() { this.src = 'https://minotar.net/avatar/Steve/32.png'; }; // エラー時デフォルト

                                    const nameSpan = document.createElement('span');
                                    nameSpan.classList.add('player-name');
                                    nameSpan.textContent = playerName;

                                    const typeBadge = document.createElement('span');
                                    typeBadge.classList.add('player-type-badge');
                                    const typeIcon = document.createElement('i');
                                    typeIcon.classList.add('fas');
                                    if (isBedrock) {
                                        typeBadge.classList.add('bedrock');
                                        typeIcon.classList.add('fa-mobile-alt');
                                    } else {
                                        typeBadge.classList.add('java');
                                        typeIcon.classList.add('fa-desktop');
                                    }
                                    typeBadge.appendChild(typeIcon);

                                    playerDiv.appendChild(img);
                                    playerDiv.appendChild(nameSpan);
                                    playerDiv.appendChild(typeBadge);
                                    playerListEl.appendChild(playerDiv);
                                });

                                if (data.players.list.length > INITIAL_PLAYERS_TO_SHOW) {
                                    viewMoreBtn.style.display = 'inline-block';
                                    viewMoreBtn.textContent = `すべて表示 (${data.players.list.length - INITIAL_PLAYERS_TO_SHOW}人)`;
                                    viewMoreBtn.onclick = function() {
                                        const hiddenPlayers = playerListEl.querySelectorAll('.hidden-player');
                                        hiddenPlayers.forEach(p => p.style.display = 'block'); // or 'flex' or 'grid' depending on styling
                                        playerListEl.parentElement.classList.add('expanded'); // スクロールバー表示のため
                                        viewMoreBtn.style.display = 'none'; // ボタンを隠す
                                        // TODO: 「少なく表示」ボタンの機能追加
                                    };
                                } else {
                                    viewMoreBtn.style.display = 'none';
                                }

                            } else {
                                noPlayersMsgEl.style.display = 'block';
                                viewMoreBtn.style.display = 'none';
                            }
                        } else {
                            statusIndicatorEl.classList.add('offline');
                            statusIndicatorEl.classList.remove('online');
                            statusIndicatorEl.querySelector('span').textContent = 'オフライン';
                            playerCountEl.textContent = '0';
                            maxPlayersEl.textContent = '-';
                            noPlayersMsgEl.style.display = 'block';
                            viewMoreBtn.style.display = 'none';
                             if (playerListCountEl) playerListCountEl.textContent = `(0)`;
                            playerListEl.innerHTML = ''; // オフラインならリストクリア
                            updateTotalPlayerCount(); // 合計プレイヤー数更新のため呼ぶ
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching status for ${serverAddress}:`, error);
                        statusIndicatorEl.classList.remove('loading');
                        statusIndicatorEl.querySelector('.pulse-dot').classList.remove('loading');
                        statusIndicatorEl.classList.add('offline'); // エラー時もオフライン扱い
                        statusIndicatorEl.classList.remove('online');
                        statusIndicatorEl.querySelector('span').textContent = '取得失敗';
                        noPlayersMsgEl.style.display = 'block';
                        viewMoreBtn.style.display = 'none';
                        if (playerListCountEl) playerListCountEl.textContent = `(?)`;
                        playerListEl.innerHTML = '<p class="error-message">情報の取得に失敗しました。</p>';
                    });
            }

            function animatePlayerCount(element, targetValue) {
                const duration = 1000; // 1秒
                const startTime = performance.now();
                const startValue = parseInt(element.textContent) || 0;

                function update(currentTime) {
                    const elapsedTime = currentTime - startTime;
                    if (elapsedTime < duration) {
                        const progress = elapsedTime / duration;
                        const currentValue = Math.round(startValue + (targetValue - startValue) * progress);
                        element.textContent = currentValue;
                        requestAnimationFrame(update);
                    } else {
                        element.textContent = targetValue;
                    }
                }
                requestAnimationFrame(update);
            }

            function updateTotalPlayerCount() {
                const totalPlayerCountEl = document.getElementById('total-player-count');
                if (totalPlayerCountEl) {
                    animatePlayerCount(totalPlayerCountEl, totalOnlinePlayers);
                }
                // 総合ステータスインジケータの更新
                const overallIndicator = document.getElementById('overall-status-indicator');
                if(overallIndicator){
                    overallIndicator.classList.remove('loading');
                    overallIndicator.querySelector('.pulse-dot').classList.remove('loading');
                    if(totalOnlinePlayers > 0){ // どちらかのサーバーがオンラインなら
                         overallIndicator.classList.add('online');
                         overallIndicator.classList.remove('offline');
                         overallIndicator.querySelector('span').textContent = 'オンライン';
                    } else {
                         overallIndicator.classList.add('offline');
                         overallIndicator.classList.remove('online');
                         overallIndicator.querySelector('span').textContent = 'オフライン';
                    }
                }
            }
            
            // 初期ロード
            totalOnlinePlayers = 0; // リセット
            fetchServerStatus(SUTERA_SERVER_ADDRESS, 'sutera');
            fetchServerStatus(VANILLA_SERVER_ADDRESS, 'vanilla');

            // 定期更新 (例: 1分ごと) - 必要に応じてコメントアウト解除
            // setInterval(() => {
            //     totalOnlinePlayers = 0; // リセット
            //     fetchServerStatus(SUTERA_SERVER_ADDRESS, 'sutera');
            //     fetchServerStatus(VANILLA_SERVER_ADDRESS, 'vanilla');
            // }, 60000);


            // --- 共通ヘッダー・アニメーション処理 再掲 (前回同様) ---
            if (hamburger && nav) {
                hamburger.addEventListener('click', () => {
                    document.body.classList.toggle('no-scroll', nav.classList.contains('active'));
                });
            }
            if (animatedElements.length > 0 && typeof IntersectionObserver !== 'undefined') {
                 const observer = new IntersectionObserver((entries, observerInstance) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add(entry.target.dataset.animation || 'fadeInUpCustom', 'is-visible');
                            entry.target.style.animationDelay = entry.target.dataset.animationDelay || '0s';
                            observerInstance.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1, rootMargin: "0px 0px -10px 0px" });
                animatedElements.forEach(el => {
                    if (el.classList.contains('animate-on-load') || (el.getBoundingClientRect().top < window.innerHeight && el.getBoundingClientRect().bottom > 0)) {
                        el.classList.add(el.dataset.animation || 'fadeInUpCustom', 'is-visible');
                        el.style.animationDelay = el.dataset.animationDelay || '0s';
                    } else {
                        observer.observe(el);
                    }
                });
            }
        });
    </script>
</body>
</html>
